analysis:
  defaultMetricProviderName: Stephen-Prometheus
  queries:
    - lowerLimit: 0
      name: avgCPUUsage-pass
      queryTemplate: >-
        avg
        (avg_over_time(container_cpu_system_seconds_total{job="kubelet"}[{{armory.promQlStepInterval}}])
        * on (pod)  group_left (annotation_app)
        sum(kube_pod_annotations{job="kube-state-metrics",annotation_deploy_armory_io_replica_set_name="{{armory.replicaSetName}}"})
        by (annotation_app, pod)) by (annotation_app)
      upperLimit: 10000
    - lowerLimit: 0
      name: invalidQuery
      queryTemplate: avg (avg_over_time(c
      upperLimit: 10000
    - lowerLimit: 0
      name: avgCPUUsage-fail
      queryTemplate: >-
        avg
        (avg_over_time(container_cpu_system_seconds_total{job="kubelet"}[{{armory.promQlStepInterval}}])
        * on (pod)  group_left (annotation_app)
        sum(kube_pod_annotations{job="kube-state-metrics",annotation_deploy_armory_io_replica_set_name="{{armory.replicaSetName}}"})
        by (annotation_app, pod)) by (annotation_app)
      upperLimit: 1
application: potato-facts3
kind: kubernetes
manifests:
  - path: manifests/potato-facts.yml
strategies:
  mycanary:
    canary:
      steps:
        - setWeight:
            weight: 25
        - analysis:
            interval: 30
            numberOfJudgmentRuns: 1
            queries:
              - avgCPUUsage-pass
            rollBackMode: manual
            rollForwardMode: automatic
            units: seconds
        - setWeight:
            weight: 50
        - analysis:
            interval: 7
            numberOfJudgmentRuns: 3
            queries:
              - avgCPUUsage-fail
              - avgCPUUsage-pass
            rollBackMode: manual
            rollForwardMode: manual
            units: seconds
        - setWeight:
            weight: 100
  rolling:
    canary:
      steps:
        - setWeight:
            weight: 100
targets:
  prod-west:
    account: demo-prod-west-cluster
    namespace: borealis-prod
    strategy: mycanary
version: v1
